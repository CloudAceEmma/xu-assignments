## 后端 API 设计文档

### 1. API 概述

本设计文档定义了项目任务管理系统的后端 API 接口。API 遵循 RESTful 风格，使用 JSON 作为数据交换格式，并通过 HTTPS 进行通信。所有 API 请求都需要进行身份验证和授权。

*   **基础 URL**: `/api/v1`
*   **认证方式**: 采用基于 Token 的认证机制（例如 JWT）。用户登录后获取 Token，后续请求在 `Authorization` 头中携带 `Bearer <Token>`。
*   **错误处理**: API 将返回标准的 HTTP 状态码，并在响应体中提供详细的错误信息（例如，`{ "code": 400, "message": "Invalid input data", "details": "..." }`）。

### 2. 项目管理 API

#### 2.1. 创建项目

*   **URL**: `POST /projects`
*   **描述**: 创建一个新的项目。
*   **请求体 (Request Body)**:
    ```json
    {
      "name": "string",          // 项目名称 (必填)
      "department": "string",    // 所属部门 (必填)
      "status": "string",        // 项目状态 (可选, 默认 "未开始")
      "leaderId": "string",      // 负责人ID (必填)
      "memberIds": ["string"],   // 成员ID列表 (可选)
      "plannedStartDate": "date",// 计划开始时间 (必填)
      "plannedEndDate": "date",  // 计划结束时间 (必填)
      "dependencies": ["string"], // 依赖项项目ID列表 (可选)
      "milestones": [            // 里程碑列表 (可选)
        {
          "name": "string",
          "dueDate": "date"
        }
      ],
      "notes": "string",         // 备注 (可选)
      "scheduleFileUrl": "string" // 进度表文件URL (可选)
    }
    ```
*   **响应体 (Response Body)**:
    ```json
    {
      "id": "string",            // 新创建的项目ID
      "name": "string",
      "department": "string",
      "status": "string",
      "leaderId": "string",
      "memberIds": ["string"],
      "plannedStartDate": "date",
      "plannedEndDate": "date",
      "actualCompletionDate": "date | null",
      "totalEffort": "number | null", // 用时 (小时)
      "completionRate": "number",
      "dependencies": ["string"],
      "milestones": [],
      "notes": "string",
      "scheduleFileUrl": "string",
      "createdAt": "datetime",
      "updatedAt": "datetime"
    }
    ```

#### 2.2. 获取项目列表

*   **URL**: `GET /projects`
*   **描述**: 获取项目列表，支持筛选、分页和排序。
*   **查询参数 (Query Parameters)**:
    *   `department`: string (可选, 按部门筛选)
    *   `status`: string (可选, 按状态筛选)
    *   `leaderId`: string (可选, 按负责人筛选)
    *   `startDate`: date (可选, 计划开始时间范围)
    *   `endDate`: date (可选, 计划结束时间范围)
    *   `page`: number (可选, 页码, 默认 1)
    *   `limit`: number (可选, 每页数量, 默认 10)
    *   `sortBy`: string (可选, 排序字段, 例如 `plannedStartDate`)
    *   `sortOrder`: string (可选, 排序顺序, `asc` 或 `desc`, 默认 `desc`)
*   **响应体 (Response Body)**:
    ```json
    {
      "total": "number",
      "page": "number",
      "limit": "number",
      "data": [
        {
          "id": "string",
          "name": "string",
          "department": "string",
          "status": "string",
          "leaderId": "string",
          "memberIds": ["string"],
          "plannedStartDate": "date",
          "plannedEndDate": "date",
          "actualCompletionDate": "date | null",
          "totalEffort": "number | null",
          "completionRate": "number",
          "dependencies": ["string"],
          "milestones": [],
          "notes": "string",
          "scheduleFileUrl": "string",
          "createdAt": "datetime",
          "updatedAt": "datetime"
        }
      ]
    }
    ```

#### 2.3. 获取项目详情

*   **URL**: `GET /projects/{projectId}`
*   **描述**: 获取指定项目的详细信息。
*   **路径参数 (Path Parameters)**:
    *   `projectId`: string (项目ID)
*   **响应体 (Response Body)**:
    ```json
    {
      "id": "string",
      "name": "string",
      "department": "string",
      "status": "string",
      "leaderId": "string",
      "memberIds": ["string"],
      "plannedStartDate": "date",
      "plannedEndDate": "date",
      "actualCompletionDate": "date | null",
      "totalEffort": "number | null",
      "completionRate": "number",
      "dependencies": ["string"],
      "milestones": [],
      "notes": "string",
      "scheduleFileUrl": "string",
      "createdAt": "datetime",
      "updatedAt": "datetime",
      "tasks": [                 // 聚合该项目下的任务概况
        {
          "id": "string",
          "name": "string",
          "status": "string",
          "completionRate": "number"
        }
      ]
    }
    ```

#### 2.4. 更新项目

*   **URL**: `PUT /projects/{projectId}`
*   **描述**: 更新指定项目的部分或全部信息。
*   **路径参数 (Path Parameters)**:
    *   `projectId`: string (项目ID)
*   **请求体 (Request Body)**:
    ```json
    {
      "name": "string",          // (可选)
      "department": "string",    // (可选)
      "status": "string",        // (可选)
      "leaderId": "string",      // (可选)
      "memberIds": ["string"],   // (可选)
      "plannedStartDate": "date",// (可选)
      "plannedEndDate": "date",  // (可选)
      "actualCompletionDate": "date | null", // (可选)
      "totalEffort": "number | null", // (可选)
      "completionRate": "number",// (可选)
      "dependencies": ["string"], // (可选)
      "milestones": [            // (可选)
        {
          "name": "string",
          "dueDate": "date"
        }
      ],
      "notes": "string",         // (可选)
      "scheduleFileUrl": "string" // (可选)
    }
    ```
*   **响应体 (Response Body)**: 同创建项目响应体。

#### 2.5. 删除项目

*   **URL**: `DELETE /projects/{projectId}`
*   **描述**: 删除指定项目及其所有关联任务。
*   **路径参数 (Path Parameters)**:
    *   `projectId`: string (项目ID)
*   **响应体 (Response Body)**:
    ```json
    {
      "message": "Project deleted successfully."
    }
    ```

### 3. 任务管理 API

#### 3.1. 创建任务

*   **URL**: `POST /tasks`
*   **描述**: 在指定项目下创建一个新任务。
*   **请求体 (Request Body)**:
    ```json
    {
      "projectId": "string",     // 所属项目ID (必填)
      "name": "string",          // 任务名称 (必填)
      "description": "string",   // 任务描述 (可选)
      "leaderId": "string",      // 任务负责人ID (必填)
      "memberIds": ["string"],   // 任务成员ID列表 (可选)
      "status": "string",        // 任务状态 (可选, 默认 "待办")
      "priority": "string",      // 任务优先级 (可选, 默认 "中")
      "plannedStartDate": "date",// 计划开始时间 (必填)
      "plannedEndDate": "date",  // 计划结束时间 (必填)
      "dependencies": ["string"] // 依赖项任务ID列表 (可选)
    }
    ```
*   **响应体 (Response Body)**:
    ```json
    {
      "id": "string",            // 新创建的任务ID
      "projectId": "string",
      "name": "string",
      "description": "string",
      "leaderId": "string",
      "memberIds": ["string"],
      "status": "string",
      "priority": "string",
      "plannedStartDate": "date",
      "plannedEndDate": "date",
      "actualCompletionDate": "date | null",
      "effortSpent": "number | null", // 实际用时 (小时)
      "completionRate": "number",
      "dependencies": ["string"],
      "createdAt": "datetime",
      "updatedAt": "datetime"
    }
    ```

#### 3.2. 获取任务列表

*   **URL**: `GET /tasks`
*   **描述**: 获取任务列表，支持按项目、按成员、按状态等筛选、分页和排序。
*   **查询参数 (Query Parameters)**:
    *   `projectId`: string (可选, 按项目ID筛选)
    *   `leaderId`: string (可选, 按负责人ID筛选)
    *   `memberId`: string (可选, 按成员ID筛选)
    *   `status`: string (可选, 按状态筛选)
    *   `priority`: string (可选, 按优先级筛选)
    *   `startDate`: date (可选, 计划开始时间范围)
    *   `endDate`: date (可选, 计划结束时间范围)
    *   `page`: number (可选, 页码, 默认 1)
    *   `limit`: number (可选, 每页数量, 默认 10)
    *   `sortBy`: string (可选, 排序字段, 例如 `plannedEndDate`)
    *   `sortOrder`: string (可选, 排序顺序, `asc` 或 `desc`, 默认 `desc`)
*   **响应体 (Response Body)**: 同创建任务响应体，但为数组形式。

#### 3.3. 获取任务详情

*   **URL**: `GET /tasks/{taskId}`
*   **描述**: 获取指定任务的详细信息。
*   **路径参数 (Path Parameters)**:
    *   `taskId`: string (任务ID)
*   **响应体 (Response Body)**: 同创建任务响应体。

#### 3.4. 更新任务

*   **URL**: `PUT /tasks/{taskId}`
*   **描述**: 更新指定任务的部分或全部信息。
*   **路径参数 (Path Parameters)**:
    *   `taskId`: string (任务ID)
*   **请求体 (Request Body)**:
    ```json
    {
      "name": "string",          // (可选)
      "description": "string",   // (可选)
      "leaderId": "string",      // (可选)
      "memberIds": ["string"],   // (可选)
      "status": "string",        // (可选)
      "priority": "string",      // (可选)
      "plannedStartDate": "date",// (可选)
      "plannedEndDate": "date",  // (可选)
      "actualCompletionDate": "date | null", // (可选)
      "effortSpent": "number | null", // (可选)
      "completionRate": "number",// (可选)
      "dependencies": ["string"] // (可选)
    }
    ```
*   **响应体 (Response Body)**: 同创建任务响应体。

#### 3.5. 删除任务

*   **URL**: `DELETE /tasks/{taskId}`
*   **描述**: 删除指定任务。
*   **路径参数 (Path Parameters)**:
    *   `taskId`: string (任务ID)
*   **响应体 (Response Body)**:
    ```json
    {
      "message": "Task deleted successfully."
    }
    ```

#### 3.6. 更新任务状态/进度

*   **URL**: `PATCH /tasks/{taskId}/status`
*   **描述**: 更新指定任务的状态和/或完成率。
*   **路径参数 (Path Parameters)**:
    *   `taskId`: string (任务ID)
*   **请求体 (Request Body)**:
    ```json
    {
      "status": "string",        // (可选)
      "completionRate": "number",// (可选, 0-100)
      "actualCompletionDate": "date | null", // (可选, 当状态为“已完成”时)
      "effortSpent": "number | null" // (可选, 当状态为“已完成”时)
    }
    ```
*   **响应体 (Response Body)**: 同获取任务详情响应体。

### 4. 预警与通知 API

#### 4.1. 获取预警列表

*   **URL**: `GET /alerts`
*   **描述**: 获取当前用户的预警通知列表。
*   **查询参数 (Query Parameters)**:
    *   `status`: string (可选, `unread` 或 `read`, 默认 `unread`)
    *   `type`: string (可选, 预警类型，例如 `overdue`, `imminent_overdue`, `dependency_blocked`, `progress_anomaly`)
    *   `page`: number (可选, 页码, 默认 1)
    *   `limit`: number (可选, 每页数量, 默认 10)
*   **响应体 (Response Body)**:
    ```json
    {
      "total": "number",
      "page": "number",
      "limit": "number",
      "data": [
        {
          "id": "string",
          "type": "string",        // 预警类型
          "message": "string",     // 预警消息
          "entityType": "string",  // 关联实体类型 (project/task)
          "entityId": "string",    // 关联实体ID
          "status": "string",      // 预警状态 (read/unread)
          "createdAt": "datetime"
        }
      ]
    }
    ```

#### 4.2. 标记预警已读

*   **URL**: `PATCH /alerts/{alertId}/read`
*   **描述**: 将指定预警标记为已读。
*   **路径参数 (Path Parameters)**:
    *   `alertId`: string (预警ID)
*   **响应体 (Response Body)**:
    ```json
    {
      "message": "Alert marked as read."
    }
    ```

### 5. 用户与权限管理 API (简化)

#### 5.1. 获取用户列表

*   **URL**: `GET /users`
*   **描述**: 获取系统用户列表。
*   **响应体 (Response Body)**:
    ```json
    [
      {
        "id": "string",
        "name": "string",
        "email": "string",
        "role": "string" // 例如: admin, leader, member
      }
    ]
    ```

#### 5.2. 获取用户详情

*   **URL**: `GET /users/{userId}`
*   **描述**: 获取指定用户详情。
*   **路径参数 (Path Parameters)**:
    *   `userId`: string (用户ID)
*   **响应体 (Response Body)**: 同获取用户列表中的单个用户对象。

### 6. AI 模块 API (假想接口)

这些 API 接口将由 AI 服务提供，供后端服务调用。

#### 6.1. 预测任务完成时间

*   **URL**: `POST /ai/predict-task-completion`
*   **描述**: 预测任务的完成时间及延期风险。
*   **请求体 (Request Body)**:
    ```json
    {
      "taskId": "string",
      "currentProgress": "number", // 当前完成率
      "historicalTaskData": "object", // 历史任务数据 (由后端提供)
      "memberEfficiency": "object" // 成员效率数据 (由后端提供)
    }
    ```
*   **响应体 (Response Body)**:
    ```json
    {
      "predictedCompletionDate": "date",
      "delayRiskLevel": "string", // high, medium, low
      "explanation": "string" // 预测解释
    }
    ```

#### 6.2. 识别项目风险

*   **URL**: `POST /ai/identify-project-risk`
*   **描述**: 智能识别项目潜在风险。
*   **请求体 (Request Body)**:
    ```json
    {
      "projectId": "string",
      "projectData": "object", // 项目所有相关数据 (由后端提供)
      "taskData": "array" // 项目下所有任务数据 (由后端提供)
    }
    ```
*   **响应体 (Response Body)**:
    ```json
    {
      "risks": [
        {
          "type": "string", // 例如: overdue, resource_bottleneck, dependency_conflict
          "level": "string", // high, medium, low
          "description": "string",
          "affectedEntities": [
            {
              "type": "string", // project/task
              "id": "string"
            }
          ]
        }
      ]
    }
    ```

#### 6.3. 估算任务工作量

*   **URL**: `POST /ai/estimate-task-effort`
*   **描述**: 估算任务所需工作量。
*   **请求体 (Request Body)**:
    ```json
    {
      "taskDescription": "string",
      "historicalSimilarTasks": "array" // 历史相似任务数据 (由后端提供)
    }
    ```
*   **响应体 (Response Body)**:
    ```json
    {
      "estimatedEffort": "number", // 估算用时 (小时)
      "confidence": "number", // 置信度 (0-1)
      "explanation": "string" // 估算依据
    }
    ```

#### 6.4. 资源优化建议

*   **URL**: `POST /ai/suggest-resource-optimization`
*   **描述**: 提供任务重新分配或资源调整建议。
*   **请求体 (Request Body)**:
    ```json
    {
      "projectId": "string",
      "teamMembers": "array", // 团队成员当前工作量和技能 (由后端提供)
      "unassignedTasks": "array", // 未分配任务 (由后端提供)
      "overloadedTasks": "array" // 负载过重任务 (由后端提供)
    }
    ```
*   **响应体 (Response Body)**:
    ```json
    {
      "suggestions": [
        {
          "type": "string", // 例如: reassign_task, adjust_deadline
          "taskId": "string",
          "suggestedAction": "string", // 建议的具体内容
          "reason": "string"
        }
      ]
    }
    ```